{% extends "base.html" %}
{% block content %}
<div class="container p-4 pt-0" data-aos="fade-up">
  <div class="card shadow-sm" style="max-width: 800px; margin: auto;">
    <div class="card-header bg-primary text-white text-center py-3 px-3">
      <h4 class="mb-0">Editar Negócio</h4>
    </div>
    <div class="card-body p-4 d-flex justify-content-center">
      <form class="row g-4 w-100" action="{{ url_for('business.edit', business_id=business['id']) }}" method="POST" enctype="multipart/form-data" id="form_geral">
        <div class="row align-items-center mt-4">
          <div class="col-auto text-center">
            <input
              class="form-control d-none"
              type="file"
              id="logoUpload"
              name="logo"
              accept="image/*"
              onchange="previewLogo(event)"
              />
            <img
              src="{{ url_for('uploads', filename=business['logo_path']) if business['logo_path'] else 'https://placehold.co/150' }}"
              alt="{{ business['nome'] }}"
              class="rounded-circle border"
              style="width: 75px; height: 75px; object-fit: cover; cursor: pointer;"
              onclick="document.getElementById('logoUpload').click();"
              />
          </div>
          <div class="col">
            <label for="nome" class="form-label" style="font-weight: 600;">Nome do negócio</label>
            <input type="text" class="form-control" id="nome" name="nome" value="{{ business['nome'] }}" required />
          </div>
        </div>
        <div class="col-12 col-md-12">
          <label for="categoria" class="form-label" style="font-weight: 600;">Categoria</label>
          <select class="form-select" name="categoria" required>
            <option value="" selected disabled>Escolha...</option>
            <option value="Alimentação" {% if business.categoria == "Alimentação" %}selected{% endif %}>Alimentação</option>
            <option value="Livros e Educação" {% if business.categoria == "Livros e Educação" %}selected{% endif %}>Livros e Educação</option>
            <option value="Tecnologia e Informática" {% if business.categoria == "Tecnologia e Informática" %}selected{% endif %}>Tecnologia e Informática</option>
            <option value="Serviços" {% if business.categoria == "Serviços" %}selected{% endif %}>Serviços</option>
            <option value="Arte e Cultura" {% if business.categoria == "Arte e Cultura" %}selected{% endif %}>Arte e Cultura</option>
            <option value="Moda e Beleza" {% if business.categoria == "Moda e Beleza" %}selected{% endif %}>Moda e Beleza</option>
            <option value="Esportes e Lazer" {% if business.categoria == "Esportes e Lazer" %}selected{% endif %}>Esportes e Lazer</option>
            <option value="Eventos e Entretenimento" {% if business.categoria == "Eventos e Entretenimento" %}selected{% endif %}>Eventos e Entretenimento</option>
            <option value="Comércio de segunda mão" {% if business.categoria == "Comércio de segunda mão" %}selected{% endif %}>Comércio de segunda mão</option>
            <option value="Pets e Animais" {% if business.categoria == "Pets e Animais" %}selected{% endif %}>Pets e Animais</option>
            <option value="Saúde e Bem-estar" {% if business.categoria == "Saúde e Bem-estar" %}selected{% endif %}>Saúde e Bem-estar</option>
            <option value="Turismo e Viagens" {% if business.categoria == "Turismo e Viagens" %}selected{% endif %}>Turismo e Viagens</option>
            <option value="Diversos" {% if business.categoria == "Diversos" %}selected{% endif %}>Diversos</option>
          </select>
        </div>
        <div class="col-12">
          <label for="descricao" class="form-label" style="font-weight: 600;">Descrição</label>
          <textarea
            class="form-control limiteDeChar"
            id="descricao"
            name="descricao"
            rows="5"
            placeholder="Fale sobre seu negócio, produtos, serviços e diferenciais."
            required
            maxlength="{{ 1200 if business['premium'] else 350 }}">{{ business['descricao'] }}
          </textarea>
          <div id="charCount">0 / 350</div>
        </div>

        
        
        {%if business['premium']%}
        <div class="col-12">
        <label class="form-label" style="font-weight: 600;">Horário de funcionamento <small>(opcional)</small></label>
        <div class="row g-3">
            {% for prefix, nome in dias %}
            <div class="col-md-6">
                <label for="{{ prefix }}_horario" class="form-label">{{ nome }}</label>
                <div class="form-check form-switch mb-1">
                    <input class="form-check-input" type="checkbox" role="switch" id="switch-{{ prefix }}">
                    <label class="form-check-label" for="switch-{{ prefix }}">Fechado</label>
                </div>
                <div class="input-group has-validation horario-input-group">
                    <input type="time" class="form-control" id="{{ prefix }}_abre" name="{{ prefix }}_abre" />
                    <input type="time" class="form-control" id="{{ prefix }}_fecha" name="{{ prefix }}_fecha" />
                </div>
            </div>
            {% endfor %}
        </div>
      </div>
        {%endif%}

        <div class="col-12">
          <label for="contato" class="form-label" style="font-weight: 600;">Contato <small>(opcional)</small></label>
          <div class="row g-3">
            {%if business['instagram'] or business['premium']%}
            <div class="col-6">
              <label for="inputInsta" class="form-label">Instagram</label>
              <div class="input-group has-validation">
                <span class="input-group-text"><i class="bi bi-instagram"></i></span>
                <input name="insta" type="text" class="form-control" id="inputInsta" placeholder="@examplo" value="{{business['instagram']}}"/>
              </div>
            </div>
            {%endif%}

          {%if business['numero'] or business['premium']%}
            <div class="col-6">
              <label for="inputNumber" class="form-label">Telefone</label>
              <div class="input-group has-validation">
                <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                <input name="number" type="text" class="form-control" id="inputNumber" placeholder="(XX) XXXXX-XXXX" value="{{business['numero']}}" />
              </div>
            </div>
            {%endif%}
            {%if business['email'] or business['premium']%}
            <div class="col-md-6">
              <label for="inputEmail" class="form-label">E-mail</label>
              <div class="input-group has-validation">
                <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                <input name="email" type="email" class="form-control" id="inputEmail" placeholder="email@exemplo.com" value="{{business['email']}}"/>
              </div>
            </div>
            {%endif%}
          </div>
        </div>

        {%if business['premium']%}

        <div class="col-12">
          <label class="form-label" style="font-weight: 600;">Localização <small>(opcional)</small></label>
          <div class="row g-3">
            <div class="col-6">
              <label for="inputCep" class="form-label">CEP <small>(opcional)</small></label>
              <input name="cep" type="integer" class="form-control" id="inputCep" placeholder="XXXXX-XXX" />
            </div>
            <div class="col-6">
              <label for="inputEstado" class="form-label">Estado</label>
              <select class="form-select" name="estado" id="inputEstado">
                 <option value="" selected disabled>Escolha...</option>
                  <option value="BA">Bahia</option>

              </select>
              <div class="invalid-feedback">
      Por favor, escolha o Estado.
     </div>
            </div>
            <div class="col-md-6">
              <label for="inputMunicipio" class="form-label">Cidade / Município</label>
               <select id="inputMunicipio" class="form-select" name="municipio">
                <option value="" selected disabled>Escolha o município...</option>
                <option value="Macajuba">Macajuba</option>
                <option value="Andaraí">Andaraí</option>
                <option value="Piatã">Piatã</option>
                <option value="Bonito">Bonito</option>
                <option value="Ibicoara">Ibicoara</option>
                <option value="Capela do Alto Alegre">Capela do Alto Alegre</option>
                <option value="Ruy Barbosa">Ruy Barbosa</option>
                <option value="Itaberaba">Itaberaba</option>
                <option value="Nova Cruz">Nova Cruz</option>
                <option value="Salvador">Salvador</option>
                <option value="Feira de Santana">Feira de Santana</option>
                <option value="Vitória da Conquista">Vitória da Conquista</option>
                <option value="Ilhéus">Ilhéus</option>
                <option value="Camaçari">Camaçari</option>
                <option value="Barreiras">Barreiras</option>
              </select>
              <div class="invalid-feedback">
      Por favor, escolha o município.
     </div>
            </div>
            <div class="col-md-6">
              <label for="inputBairro" class="form-label">Bairro</label>
              <input name="bairro" type="text" class="form-control" id="inputBairro" />
              <div class="invalid-feedback">
      Por favor, digite o bairro.
     </div>
            </div>
            <div class="col-9">
              <label for="inputRuaAvenida" class="form-label">Rua / Avenida</label>
              <div class="input-group has-validation">
                <input name="ruaAvenida" type="text" class="form-control" id="inputRuaAvenida" />
              </div>
              <div class="invalid-feedback">
      Por favor, digite a rua/avenida.
     </div>
            </div>
            <div class="col-3">
              <label for="numeroCasa" class="form-label">Número</label>
              <input name="numeroCasa" type="text" class="form-control" id="inputNumeroCasa" />
              <div class="invalid-feedback">
      Por favor, digite o número.
     </div>
            </div>
          </div>
        </div>
        <div class="col-12">
          <label for="imageUpload" class="form-label d-block" style="font-weight: 600;">
          Imagens <small>(opcional)</small>
          </label>
          <input
            class="form-control"
            type="file"
            id="imageUpload"
            name="images[]"
            accept="image/*"
            multiple
            />
          <div id="previewContainer" class="d-flex flex-wrap gap-2 mt-2">
            <!-- imagens já existentes -->
            {% for image in images_urls %}
            <div class="position-relative" data-existing="true" data-filename="{{ image.image_path }}">
              <img src="{{ url_for('uploads', filename=image['image_path']) }}" 
                class="rounded border" 
                style="width:120px;height:120px;object-fit:cover;">
              <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0"
                style="transform: translate(50%, -50%);"
                onclick="removeExistingImage(this)">×</button>
            </div>
            {% endfor %}
          </div>
        </div>
        
        <script>
          const previewContainer = document.getElementById("previewContainer");
          const imageInput = document.getElementById("imageUpload");
          let selectedFiles = [];
          
          // Remove nova imagem selecionada
          function updatePreviews() {
            previewContainer.innerHTML = ""; // limpa previews
          
            // imagens existentes que ainda não foram marcadas para remoção
            existingImages.forEach(img => {
              const div = document.createElement("div");
              div.className = "row position-relative g-1";
              div.dataset.existing = "true";
              div.dataset.filename = img;
              
              const imageElem = document.createElement("img");
              imageElem.src = `/var/data/uploads/${img}`;
              imageElem.className = "rounded";
              imageElem.style.width = "7rem";
              imageElem.style.height = "7rem";
              imageElem.style.objectFit = "cover";
          
              const btn = document.createElement("button");
              btn.type = "button";
              btn.innerHTML = "&times;";
              btn.className = "btn btn-sm btn-danger position-absolute top-0 end-0";
              btn.onclick = () => removeExistingImage(btn);
          
              div.appendChild(imageElem);
              div.appendChild(btn);
              previewContainer.appendChild(div);
            });
          
            //imagens novas selecionadas
            selectedFiles.forEach((file, index) => {
  const div = document.createElement("div");
  div.className = "row position-relative g-1";

  const img = document.createElement("img");
  img.src = URL.createObjectURL(file);
  img.className = "rounded";
  img.style.width = "7rem";
  img.style.height = "7rem";
  img.style.objectFit = "cover";

  const btn = document.createElement("button");
  btn.type = "button";
  btn.innerHTML = "&times;";
  btn.className = "btn btn-sm btn-danger position-absolute top-0 start-0 w-100";
  btn.onclick = () => {
    selectedFiles.splice(index, 1);
    updatePreviews();
    updateInputFiles();
  };

  div.appendChild(img);
  div.appendChild(btn);
  previewContainer.appendChild(div);
});
          }
          
          // Função para remover imagens existentes
          function removeExistingImage(btn) {const div = btn.closest("div");
            const filename = div.dataset.filename;

            // remove do array de existentes
            existingImages = existingImages.filter(img => img !== filename);

            // remove o elemento da tela
            div.remove();

            // adiciona a um input escondido para backend excluir
            let input = document.getElementById("removedImages");
            if (!input) {
                input = document.createElement("input");
                input.type = "hidden";
                input.id = "removedImages";
                input.name = "removed_images";
                document.querySelector("form").appendChild(input);
                input.value = filename;
            } else {
                const current = input.value.split(",");
                current.push(filename);
                input.value = current.join(",");
            }
        }
          
          // Atualiza input file para enviar apenas arquivos selecionados
          function updateInputFiles() {
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(file => dataTransfer.items.add(file));
            imageInput.files = dataTransfer.files;
          }
          
          imageInput.addEventListener("change", (e) => {
            const files = Array.from(e.target.files);
            selectedFiles = selectedFiles.concat(files);
            updatePreviews();
            updateInputFiles();
          });
          
          // Inicialmente, você pode criar um array de imagens existentes
          let existingImages = [
            {% for image in images_urls %}
              "{{ image['image_path'] }}",
            {% endfor %}
          ];
          updatePreviews();
        </script>
        {%endif%}
        <div class="d-grid mt-4">
          <button type="submit" class="btn btn-primary">Editar Negócio</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function previewLogo(event) {
    const [file] = event.target.files;
    if (file) {
      const imgElement = event.target.closest('div').querySelector('img');
      imgElement.src = URL.createObjectURL(file);
    }
  }
  
  function previewImages(event) {
    const files = event.target.files;
    const previewContainer = document.getElementById("previewContainer");
  
    // limpa previews antigos
    previewContainer.innerHTML = "";
  
    // percorre todos os arquivos selecionados
    for (const file of files) {
      if (!file.type.startsWith("image/")) continue;
  
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.className = "rounded border";
      img.style.width = "150px";
      img.style.height = "150px";
      img.style.objectFit = "cover";
      previewContainer.appendChild(img);
    }
  }
</script>

<script>

// Input fields
const estadoInput = document.getElementById("inputEstado");
const municipioInput = document.getElementById("inputMunicipio");
const bairroInput = document.getElementById("inputBairro");
const ruaAvenidaInput = document.getElementById("inputRuaAvenida");
const numeroCasaInput = document.getElementById("inputNumeroCasa");

// Array
const localizacaoInputs = [estadoInput, municipioInput, bairroInput, ruaAvenidaInput, numeroCasaInput];

// Gerenciar 
function handleInputBehavior(){

  const filledInput = localizacaoInputs.find(input => input.value.trim() !== '');

  //Se um dos contatos tem algum valor, desativa os outros
  if (filledInput) {
    localizacaoInputs.forEach(input => {
      if (input !== filledInput) {
        input.required = true;
        input.classList.add('required');
      }
    });
  } else{
    //Se não tem nenhum valor, re-ativa todos.
    localizacaoInputs.forEach(input => {
      input.required = false;
      input.classList.remove('required');
    })
  }
}

//Adiciona event listeners para cada input
localizacaoInputs.forEach(input => {
  input.addEventListener('input', handleInputBehavior);
});


(() => {
  const form = document.getElementById('form_geral');
  form.addEventListener('submit', event => {
    handleInputBehavior();
    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    }

    form.classList.add('needs-validation');
  }, false);
})();

</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Seleciona todos os switches de "Fechado"
        const toggleSwitches = document.querySelectorAll('.form-check-input[type="checkbox"]');

        toggleSwitches.forEach(function(toggle) {
            // Adiciona um listener para cada switch
            toggle.addEventListener('change', function() {
                // Encontra o grupo de inputs de horário correspondente
                const inputGroup = this.closest('.col-md-6').querySelector('.horario-input-group');
                const timeInputs = inputGroup.querySelectorAll('input[type="time"]');
                
                // Se o switch estiver checado, desabilita os inputs
                if (this.checked) {
                    timeInputs.forEach(input => {
                        input.disabled = true;
                        input.value = ''; // Limpa o valor para não enviar dados inválidos
                    });
                } else {
                    // Se não estiver checado, habilita os inputs
                    timeInputs.forEach(input => {
                        input.disabled = false;
                    });
                }
            });
        });
    });
</script>


{% endblock %}